{"version":3,"file":"SharedElementRendererData.js","sourceRoot":"","sources":["../src/SharedElementRendererData.ts"],"names":[],"mappings":"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","sourcesContent":["import { SharedElementCompatRouteProxy } from \"./SharedElementCompatRouteProxy\";\nimport SharedElementSceneData, {\n  SharedElementSceneEventType,\n} from \"./SharedElementSceneData\";\nimport {\n  SharedElementEventSubscription,\n  SharedElementsStrictConfig,\n  SharedElementAnimatedValue,\n  SharedElementTransitionProps,\n  SharedElementRoute,\n} from \"./types\";\nimport { normalizeSharedElementsConfig } from \"./utils\";\n\nexport type SharedElementRendererUpdateHandler = () => any;\n\nexport interface ISharedElementRendererData {\n  startTransition(\n    closing: boolean,\n    navigatorId: string,\n    nestingDepth: number\n  ): void;\n  endTransition(\n    closing: boolean,\n    navigatorId: string,\n    nestingDepth: number\n  ): void;\n  updateSceneState(\n    scene: SharedElementSceneData,\n    eventType: SharedElementSceneEventType\n  ): void;\n  readonly nestingDepth: number;\n  addDebugRef(): number;\n  releaseDebugRef(): number;\n}\n\nfunction getSharedElements(\n  scene: SharedElementSceneData,\n  otherScene: SharedElementSceneData,\n  showing: boolean\n): SharedElementsStrictConfig | null {\n  const sharedElements = scene.getSharedElements();\n  if (!sharedElements) return null;\n  return normalizeSharedElementsConfig(\n    sharedElements(\n      new SharedElementCompatRouteProxy(scene.route),\n      new SharedElementCompatRouteProxy(otherScene.route),\n      showing\n    )\n  );\n}\n\nconst NO_SHARED_ELEMENTS: any[] = [];\n\ntype SceneRoute = {\n  scene: SharedElementSceneData;\n  subscription: SharedElementEventSubscription | null;\n};\n\n/**\n * TODO\n * - [ ] Not all lifecycle events not emitted by stack when using gestures (close modal)\n */\n\nexport default class SharedElementRendererData\n  implements ISharedElementRendererData\n{\n  private scenes: SceneRoute[] = [];\n  private updateSubscribers = new Set<SharedElementRendererUpdateHandler>();\n  private sharedElements: SharedElementsStrictConfig | null = null;\n  private isShowing: boolean = true;\n\n  private route: SharedElementRoute | null = null;\n  private prevRoute: SharedElementRoute | null = null;\n  private routeAnimValue: SharedElementAnimatedValue;\n\n  private scene: SharedElementSceneData | null = null;\n  private prevScene: SharedElementSceneData | null = null;\n  private sceneAnimValue: SharedElementAnimatedValue;\n\n  private isTransitionStarted: boolean = false;\n  private isTransitionClosing: boolean = false;\n  private transitionNavigatorId: string = \"\";\n  private transitionNestingDepth: number = -1;\n\n  public debugRefCount: number = 0;\n\n  startTransition(closing: boolean, navigatorId: string, nestingDepth: number) {\n    if (this.debug)\n      console.debug(\n        `[${navigatorId}]startTransition, closing: ${closing}, nestingDepth: ${nestingDepth}`\n      );\n\n    if (!this.isTransitionStarted || this.route) {\n      this.prevRoute = this.route;\n      this.route = null;\n      this.routeAnimValue = null;\n\n      // When a transition wasn't completely fully, but a new transition\n      // has already started, then the `willBlur` event is not called.\n      // For this particular case, we capture the animation-value of the\n      // last (previous) scene that is now being hidden.\n      if (this.isTransitionStarted) {\n        const scene = this.getScene(this.prevRoute);\n        if (scene) {\n          this.routeAnimValue = scene.getAnimValue(true);\n        }\n      }\n\n      this.isTransitionStarted = true;\n      this.isTransitionClosing = closing;\n      this.transitionNavigatorId = navigatorId;\n      this.transitionNestingDepth = nestingDepth;\n    } else {\n      // When navigators are nested, `startTransition` may be called multiple\n      // times. In such as case, we want to use the most shallow navigator,\n      // as that is the one doing the transition.\n      if (nestingDepth < this.transitionNestingDepth) {\n        this.transitionNavigatorId = navigatorId;\n        this.transitionNestingDepth = nestingDepth;\n      }\n    }\n  }\n\n  endTransition(closing: boolean, navigatorId: string, nestingDepth: number) {\n    if (this.debug)\n      console.debug(\n        `[${navigatorId}]endTransition, closing: ${closing}, nestingDepth: ${nestingDepth}`\n      );\n\n    if (\n      !this.isTransitionStarted ||\n      this.transitionNavigatorId !== navigatorId\n    ) {\n      return;\n    }\n\n    this.isTransitionStarted = false;\n\n    if (this.prevRoute != null) {\n      this.prevRoute = null;\n      this.routeAnimValue = null;\n      this.updateSceneListeners();\n      this.updateSharedElements();\n    }\n  }\n\n  updateSceneState(\n    scene: SharedElementSceneData,\n    eventType: SharedElementSceneEventType\n  ): void {\n    switch (eventType) {\n      case \"willFocus\":\n        return this.willFocusScene(scene);\n      case \"didFocus\":\n        return this.didFocusScene(scene);\n      /*case \"willBlur\":\n        return this.willBlurScene(scene);*/\n    }\n  }\n\n  addDebugRef(): number {\n    return ++this.debugRefCount;\n  }\n\n  releaseDebugRef(): number {\n    return --this.debugRefCount;\n  }\n\n  get debug() {\n    return this.debugRefCount > 0;\n  }\n\n  willFocusScene(scene: SharedElementSceneData): void {\n    if (this.debug)\n      console.debug(\n        `[${scene.navigatorId}]willFocus, scene: \"${scene.name}\", depth: ${scene.nestingDepth}, closing: ${this.isTransitionClosing}`\n      );\n    this.registerScene(scene);\n\n    // Wait for a transition start, before starting any animations\n    if (!this.isTransitionStarted) return;\n\n    // Use the animation value from the navigator that\n    // started the transition\n    if (this.prevRoute) {\n      const routeScene = this.isTransitionClosing\n        ? this.getScene(this.prevRoute)\n        : scene;\n      if (routeScene?.navigatorId === this.transitionNavigatorId) {\n        this.routeAnimValue = routeScene?.getAnimValue(\n          this.isTransitionClosing\n        );\n      }\n    }\n\n    // In case of nested navigators, multiple scenes will become\n    // activated. Make sure to use the scene that is nested most deeply,\n    // as this will be the one visible to the user\n    if (!this.route) {\n      this.route = scene.route;\n    } else {\n      const routeScene = this.getScene(this.route);\n      if (routeScene && routeScene.nestingDepth <= scene.nestingDepth) {\n        this.route = scene.route;\n      }\n    }\n\n    // Update transition\n    if (this.prevRoute && this.route && this.routeAnimValue) {\n      this.updateSceneListeners();\n      this.updateSharedElements();\n    }\n  }\n\n  didFocusScene(scene: SharedElementSceneData): void {\n    if (this.debug)\n      console.debug(\n        `[${scene.navigatorId}]didFocus, scene: \"${scene.name}\", depth: ${scene.nestingDepth}`\n      );\n\n    if (!this.route || this.prevRoute) {\n      this.route = scene.route;\n    } else {\n      const routeScene = this.getScene(this.route);\n      if (routeScene && routeScene.nestingDepth <= scene.nestingDepth) {\n        this.route = scene.route;\n      }\n    }\n    this.registerScene(scene);\n  }\n\n  /*willBlurScene(scene: SharedElementSceneData): void {\n    if (this.debug)\n      console.debug(\n        `[${scene.navigatorId}]willBlur, scene: \"${scene.name}\", depth: ${scene.nestingDepth}`\n      );\n\n    // Wait for a transition start, before starting any animations\n    if (!this.isTransitionStarted) return;\n\n    // Use the animation value from the navigator that\n    // started the transition\n    if (\n      this.isTransitionClosing &&\n      scene.navigatorId === this.transitionNavigatorId &&\n      !this.routeAnimValue\n    ) {\n      this.routeAnimValue = scene.getAnimValue(this.isTransitionClosing);\n    }\n\n    // Update transition\n    if (this.prevRoute && this.route && this.routeAnimValue) {\n      this.updateSceneListeners();\n      this.updateSharedElements();\n    }\n  }*/\n\n  private registerScene(scene: SharedElementSceneData) {\n    this.scenes.push({\n      scene,\n      subscription: null,\n    });\n    if (this.scenes.length > 10) {\n      const { subscription } = this.scenes[0];\n      this.scenes.splice(0, 1);\n      subscription?.();\n    }\n    this.updateSceneListeners();\n  }\n\n  private updateSceneListeners() {\n    this.scenes.forEach((sceneRoute) => {\n      const { scene, subscription } = sceneRoute;\n      const isActive =\n        (this.route && this.route.key === scene.route.key) ||\n        (this.prevRoute && this.prevRoute.key === scene.route.key);\n      if (isActive && !subscription) {\n        sceneRoute.subscription = scene.addUpdateListener(() => {\n          // TODO: optimize?\n          this.emitUpdateEvent();\n        });\n      } else if (!isActive && subscription) {\n        sceneRoute.subscription = null;\n        subscription();\n      }\n    });\n  }\n\n  private getScene(\n    route: SharedElementRoute | null\n  ): SharedElementSceneData | null {\n    const sceneRoute = route\n      ? this.scenes.find((sc) => sc.scene.route.key === route.key)\n      : undefined;\n    return sceneRoute ? sceneRoute.scene : null;\n  }\n\n  private updateSharedElements() {\n    const { route, prevRoute, routeAnimValue } = this;\n    const scene = this.getScene(route);\n    const prevScene = this.getScene(prevRoute);\n    const sceneAnimValue = routeAnimValue;\n\n    // Update current scene & previous scene\n    if (\n      scene === this.scene &&\n      prevScene === this.prevScene &&\n      sceneAnimValue === this.sceneAnimValue\n    )\n      return;\n    this.scene = scene;\n    this.prevScene = prevScene;\n    this.sceneAnimValue = sceneAnimValue;\n\n    // Update shared elements\n    let sharedElements: SharedElementsStrictConfig | null = null;\n    let isShowing = true;\n    if (sceneAnimValue && scene && prevScene && route && prevRoute) {\n      sharedElements = getSharedElements(scene, prevScene, true);\n      if (!sharedElements) {\n        isShowing = false;\n        sharedElements = getSharedElements(prevScene, scene, false);\n      }\n    }\n    if (this.sharedElements !== sharedElements) {\n      if (this.debug) {\n        if (sharedElements) {\n          console.debug(\n            `Transition start: \"${prevScene?.name}\" -> \"${\n              scene?.name\n            }\", elements: ${JSON.stringify(sharedElements, undefined, 2)}`\n          );\n        } else {\n          console.debug(`Transition end: \"${scene?.name}\"`);\n        }\n      }\n      this.sharedElements = sharedElements;\n      this.isShowing = isShowing;\n      /*console.log(\n        'updateSharedElements: ',\n        sharedElements,\n        ' ,isShowing: ',\n        isShowing,\n        ', animValue: ',\n        animValue\n      );*/\n      this.emitUpdateEvent();\n    }\n  }\n\n  addUpdateListener(\n    handler: SharedElementRendererUpdateHandler\n  ): SharedElementEventSubscription {\n    this.updateSubscribers.add(handler);\n    return () => this.updateSubscribers.delete(handler);\n  }\n\n  private emitUpdateEvent(): void {\n    this.updateSubscribers.forEach((handler) => handler());\n  }\n\n  getTransitions(): SharedElementTransitionProps[] {\n    const { sharedElements, prevScene, scene, isShowing, sceneAnimValue } =\n      this;\n\n    if (!sharedElements || !scene || !prevScene) return NO_SHARED_ELEMENTS;\n    return sharedElements.map(({ id, otherId, ...other }) => {\n      const startId = isShowing ? otherId || id : id;\n      const endId = isShowing ? id : otherId || id;\n      return {\n        key: scene.route.key,\n        position: sceneAnimValue,\n        start: {\n          ancestor: (prevScene ? prevScene.getAncestor() : undefined) || null,\n          node: (prevScene ? prevScene.getNode(startId) : undefined) || null,\n        },\n        end: {\n          ancestor: (scene ? scene.getAncestor() : undefined) || null,\n          node: (scene ? scene.getNode(endId) : undefined) || null,\n        },\n        ...other,\n      };\n    });\n  }\n\n  get nestingDepth(): number {\n    return 0;\n  }\n}\n"]}