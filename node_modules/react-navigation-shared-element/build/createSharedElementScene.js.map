{"version":3,"file":"createSharedElementScene.js","sourceRoot":"","sources":["../src/createSharedElementScene.tsx"],"names":[],"mappings":"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","sourcesContent":["import { Route, NavigationState } from \"@react-navigation/native\";\nimport {\n  StackNavigationProp,\n  StackCardInterpolationProps,\n} from \"@react-navigation/stack\";\nimport hoistNonReactStatics from \"hoist-non-react-statics\";\nimport * as React from \"react\";\nimport { View, StyleSheet, InteractionManager } from \"react-native\";\nimport { nodeFromRef } from \"react-native-shared-element\";\n\nimport { ISharedElementRendererData } from \"./SharedElementRendererData\";\nimport SharedElementSceneContext from \"./SharedElementSceneContext\";\nimport SharedElementSceneData from \"./SharedElementSceneData\";\nimport {\n  SharedElementEventSubscription,\n  SharedElementSceneComponent,\n  SharedElementRoute,\n  SharedElementsComponentConfig,\n} from \"./types\";\nimport { EventEmitter } from \"./utils/EventEmitter\";\n\nconst styles = StyleSheet.create({\n  container: {\n    flex: 1,\n  },\n});\n\ntype PropsType = {\n  navigation: StackNavigationProp<any>;\n  route: SharedElementRoute;\n};\n\nfunction isValidNavigationState(\n  state: Partial<NavigationState>\n): state is NavigationState {\n  return \"index\" in state && \"routes\" in state;\n}\n\n// Gets the current screen from navigation state\nfunction getActiveRoute(state: NavigationState): Route<any> {\n  const route = state.routes[state.index];\n  const routeState = route.state as Partial<NavigationState>;\n  return route.state && isValidNavigationState(routeState)\n    ? getActiveRoute(routeState) // Dive into nested navigators\n    : route;\n}\n\nfunction isActiveRoute(\n  navigation: StackNavigationProp<any>,\n  route: Route<any>\n): boolean {\n  // @ts-ignore: getState is supported by navigation 6\n  const state: NavigationState = navigation.getState\n    ? // @ts-ignore: getState is supported by navigation 6\n      navigation.getState()\n    : // @ts-ignore: dangerouslyGetState is provided for navigation 5 compatibility\n      navigation.dangerouslyGetState();\n  const activeRoute = getActiveRoute(state);\n  return route.name === activeRoute.name;\n}\n\nfunction createSharedElementScene(\n  Component: SharedElementSceneComponent,\n  sharedElements: SharedElementsComponentConfig | void,\n  rendererData: ISharedElementRendererData,\n  emitter: EventEmitter,\n  AnimationContext: React.Context<StackCardInterpolationProps | undefined>,\n  navigatorId: string,\n  verbose: boolean\n): React.ComponentType<any> {\n  const config = {\n    Component,\n    sharedElements,\n    rendererData,\n    AnimationContext,\n    navigatorId,\n    verbose,\n  };\n\n  class SharedElementSceneView extends React.PureComponent<PropsType> {\n    private subscriptions: {\n      [key: string]: SharedElementEventSubscription;\n    } = {};\n    private sceneData: SharedElementSceneData = new SharedElementSceneData(\n      Component,\n      () => config.sharedElements || Component.sharedElements,\n      this.props.route,\n      navigatorId,\n      rendererData.nestingDepth,\n      verbose\n    );\n\n    static readonly config = config;\n\n    componentDidMount() {\n      const { navigation } = this.props;\n      this.subscriptions = {\n        willFocus: emitter.addListener(\"focus\", this.onWillFocus),\n        willBlur: emitter.addListener(\"blur\", this.onWillBlur),\n        transitionStart: navigation.addListener(\n          \"transitionStart\",\n          this.onTransitionStart\n        ),\n        transitionEnd: navigation.addListener(\n          \"transitionEnd\",\n          this.onTransitionEnd\n        ),\n      };\n    }\n\n    private onTransitionStart = (event: any) => {\n      const closing: boolean = event.data.closing;\n      rendererData.startTransition(\n        closing,\n        navigatorId,\n        rendererData.nestingDepth\n      );\n      //rendererData.updateSceneState(this.sceneData, \"willFocus\");\n    };\n\n    private onTransitionEnd = ({ data: { closing } }: any) => {\n      rendererData.endTransition(\n        closing,\n        navigatorId,\n        rendererData.nestingDepth\n      );\n    };\n\n    componentWillUnmount() {\n      Object.values(this.subscriptions).forEach((unsubscribe) => unsubscribe());\n    }\n\n    render() {\n      // console.log('SharedElementSceneView.render');\n      return (\n        <SharedElementSceneContext.Provider value={this.sceneData}>\n          <View\n            style={styles.container}\n            collapsable={false}\n            ref={this.onSetRef}\n          >\n            <AnimationContext.Consumer>\n              {this.onRenderAnimationContext}\n            </AnimationContext.Consumer>\n            <Component {...this.props} />\n          </View>\n        </SharedElementSceneContext.Provider>\n      );\n    }\n\n    private onRenderAnimationContext = (\n      value: StackCardInterpolationProps | undefined\n    ) => {\n      this.sceneData.setAnimimationContextValue(value);\n      return null;\n    };\n\n    componentDidUpdate() {\n      this.sceneData.updateRoute(this.props.route);\n    }\n\n    private onSetRef = (ref: any) => {\n      this.sceneData.setAncestor(nodeFromRef(ref));\n    };\n\n    private onWillFocus = () => {\n      const { navigation, route } = this.props;\n\n      //console.log(\"onWillFocus: \", route);\n      if (isActiveRoute(navigation, route)) {\n        this.sceneData.updateRoute(route);\n        rendererData.updateSceneState(this.sceneData, \"willFocus\");\n        InteractionManager.runAfterInteractions(() => {\n          //console.log(\"onDidFocus: \", this.props.route);\n          this.sceneData.updateRoute(this.props.route);\n          rendererData.updateSceneState(this.sceneData, \"didFocus\");\n        });\n      }\n    };\n\n    private onWillBlur = () => {\n      const { route } = this.props;\n\n      //console.log(\"onWillBlur: \", route);\n      this.sceneData.updateRoute(route);\n      //rendererData.updateSceneState(this.sceneData, \"willBlur\");\n    };\n  }\n\n  hoistNonReactStatics(SharedElementSceneView, Component);\n  return SharedElementSceneView;\n}\n\nexport default createSharedElementScene;\n"]}